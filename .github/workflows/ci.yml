name: ğŸƒâ€â™‚ï¸ GigaChad Runner CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

jobs:
  # ì½”ë“œ í’ˆì§ˆ ë° í…ŒìŠ¤íŠ¸
  test:
    name: ğŸ§ª Test & Analyze
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: â˜• Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: ğŸ¯ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.32.0'
        channel: 'stable'
        cache: true

    - name: ğŸ“¦ Get dependencies
      run: flutter pub get

    - name: ğŸ” Verify format
      run: dart format --output=none --set-exit-if-changed .

    - name: ğŸ“Š Analyze project source
      run: flutter analyze

    - name: ğŸ§ª Run tests
      run: flutter test --coverage

    - name: ğŸ“ˆ Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: coverage/lcov.info
        fail_ci_if_error: true

  # Android ë¹Œë“œ
  build-android:
    name: ğŸ¤– Build Android APK
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' || github.event_name == 'release'

    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: â˜• Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: ğŸ¯ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.32.0'
        channel: 'stable'
        cache: true

    - name: ğŸ“¦ Get dependencies
      run: flutter pub get

    - name: ğŸ”¨ Build APK (Debug)
      if: github.event_name == 'push'
      run: flutter build apk --debug

    - name: ğŸ”¨ Build APK (Release)
      if: github.event_name == 'release'
      run: flutter build apk --release

    - name: ğŸ“¤ Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: gigachad-runner-${{ github.event_name == 'release' && 'release' || 'debug' }}-apk
        path: build/app/outputs/flutter-apk/*.apk
        retention-days: 30

  # AAB ë¹Œë“œ (Play Storeìš©)
  build-aab:
    name: ğŸ“± Build Android App Bundle
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'release'

    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: â˜• Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: ğŸ¯ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.32.0'
        channel: 'stable'
        cache: true

    - name: ğŸ“¦ Get dependencies
      run: flutter pub get

    - name: ğŸ”¨ Build App Bundle
      run: flutter build appbundle --release

    - name: ğŸ“¤ Upload AAB artifact
      uses: actions/upload-artifact@v4
      with:
        name: gigachad-runner-release-aab
        path: build/app/outputs/bundle/release/*.aab
        retention-days: 30

  # ë¦´ë¦¬ì¦ˆ ìë™í™”
  release:
    name: ğŸš€ Create Release
    runs-on: ubuntu-latest
    needs: [test, build-android, build-aab]
    if: github.event_name == 'release'

    steps:
    - name: ğŸ“¥ Download APK
      uses: actions/download-artifact@v4
      with:
        name: gigachad-runner-release-apk
        path: ./artifacts/

    - name: ğŸ“¥ Download AAB
      uses: actions/download-artifact@v4
      with:
        name: gigachad-runner-release-aab
        path: ./artifacts/

    - name: ğŸ“‹ Get APK info
      id: apk_info
      run: |
        APK_FILE=$(find ./artifacts -name "*.apk" | head -1)
        AAB_FILE=$(find ./artifacts -name "*.aab" | head -1)
        echo "apk_file=$APK_FILE" >> $GITHUB_OUTPUT
        echo "aab_file=$AAB_FILE" >> $GITHUB_OUTPUT

    - name: ğŸ·ï¸ Upload Release Assets
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ${{ steps.apk_info.outputs.apk_file }}
          ${{ steps.apk_info.outputs.aab_file }}
        name: GigaChad Runner ${{ github.event.release.tag_name }}
        body: |
          ## ğŸƒâ€â™‚ï¸ GigaChad Runner ${{ github.event.release.tag_name }}

          ### ğŸ“± ë‹¤ìš´ë¡œë“œ
          - **APK**: Android ê¸°ê¸°ì— ì§ì ‘ ì„¤ì¹˜
          - **AAB**: Google Play Store ë°°í¬ìš©

          ### âœ¨ ë³€ê²½ì‚¬í•­
          ${{ github.event.release.body }}

          ### ğŸ”§ ê¸°ìˆ  ì •ë³´
          - Flutter: 3.32.0
          - Dart: 3.0+
          - Android: API 21+

          ---
          **Made with ğŸ’ª by Chad Developers**
        draft: false
        prerelease: ${{ github.event.release.prerelease }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ì½”ë“œ í’ˆì§ˆ ê²Œì´íŠ¸
  quality-gate:
    name: ğŸ›¡ï¸ Quality Gate
    runs-on: ubuntu-latest
    needs: [test, build-android]
    if: github.event_name == 'pull_request'

    steps:
    - name: âœ… All checks passed
      run: |
        echo "ğŸ‰ All quality checks passed!"
        echo "âœ… Tests: Passed"
        echo "âœ… Analysis: Passed"
        echo "âœ… Build: Passed"
        echo "ğŸš€ Ready to merge!"